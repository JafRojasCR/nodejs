<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Diseño de Camiseta</title>
    <link rel="stylesheet" href="/css/camiseta" />
    <link rel="stylesheet" href="/css/header" />
    <link rel="manifest" href="/manifest.json" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css"
    />
  </head>
  <body>
    <div class="header">
      <div class="inner">
        <div class="leftSide"><h2>Diseña tu Camiseta</h2></div>
        <div class="rightSide">
          <a onclick="redirect(0)" class="headerElement active"
            >Diseña tu camiseta</a
          >
          <a onclick="redirect(1)" class="headerElement">Votaciones</a>
          <a onclick="redirect(2)" class="headerElement">Mi perfil</a>
          <a onclick="redirect(3)" class="headerElement">Salir</a>
        </div>
      </div>
    </div>
    <!-- Dentro del body HTML -->
    <div class="camiseta-container">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="1 2 26 14"
        id="camiseta-svg"
      >
        <path
          class="parte-camiseta"
          id="manga-izquierda"
          d="M 4 8 M 5 3 L 5 6 L 3 7 L 1 5"
          fill="#000000"
        />
        <path
          class="parte-camiseta"
          id="torso"
          d="M 9 5 L 7 3 L 5 3 L 5 6 L 5 12 L 13 12 L 13 6 L 13 3 L 11 3"
          fill="#000000"
        />
        <path
          class="parte-camiseta"
          id="manga-derecha"
          d="M 13 6 L 13 3 L 17 5 L 15 7"
          fill="#000000"
        />
        <path
          class="parte-camiseta"
          id="cuelloizq"
          d="M 8 2 L 7 3 L 9 5 L 8 3"
          fill="#000000"
        />
        <path
          class="parte-camiseta"
          id="cuelloder"
          d="M 10 2 L 11 3 L 9 5 L 10 3 M 1 4"
          fill="#000000"
        />

        <!--      -->
      </svg>
      <div class="controls">
        <input type="color" id="color-picker" value="#ffffff" />
        <button id="btn-guardar">Guardar Diseño</button>
        <button id="btn-modificar-real">Modificar Diseño</button>
        <button id="btn-limpiar">Reiniciar Colores</button>
        <input type="hidden" id="camiseta-id" />
      </div>
    </div>
    <!-- Selector de color y botones -->

    <table id="tabla-camisetas" class="display">
      <thead>
        <tr>
          <th>Miniatura</th>
          <th>Fecha creación</th>
          <th>Creador</th>
          <!-- Nueva columna para el nombre/correo del creador -->
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <!-- El cuerpo se llenará dinámicamente -->
      </tbody>
    </table>

    <script>
      // Referencias a elementos del DOM
      const svg = document.getElementById("camiseta-svg");
      const colorPicker = document.getElementById("color-picker");
      const btnGuardar = document.getElementById("btn-guardar");
      const btnLimpiar = document.getElementById("btn-limpiar");
      const btnModificarReal = document.getElementById("btn-modificar-real");
      const camisetaIdInput = document.getElementById("camiseta-id");
      btnModificarReal.style.display = "none"; // Ocultar botón modificar inicialmente
      const token = localStorage.getItem("token"); // Obtener token de localStorage si es necesario

      let parteSeleccionada = null; // elemento SVG actualmente seleccionado por el usuario

      // Event listener para seleccionar parte de la camiseta al hacer click
      svg.addEventListener("click", (event) => {
        if (event.target.classList.contains("parte-camiseta")) {
          parteSeleccionada = event.target; // establece la parte clickeada como seleccionada
          // Opcional: resaltar de alguna forma la parte seleccionada, o mostrar su nombre
          console.log("Parte seleccionada:", parteSeleccionada.id);
          // Actualizar el colorPicker al color actual de la parte
          const colorActual = parteSeleccionada.getAttribute("fill");
          colorPicker.value = colorActual;
        }
      });

      // Event listener para cambiar color de la parte seleccionada
      colorPicker.addEventListener("input", (event) => {
        if (parteSeleccionada) {
          parteSeleccionada.setAttribute("fill", event.target.value);
        }
      });

      // Botón para reiniciar todos los colores a blanco
      btnLimpiar.addEventListener("click", () => {
        document.querySelectorAll(".parte-camiseta").forEach((el) => {
          el.setAttribute("fill", "#000000");
        });
      });

      btnGuardar.addEventListener("click", async () => {
        // Obtener colores actuales de cada parte
        const datos = {
          torso: document.getElementById("torso").getAttribute("fill"),
          mangaizq: document
            .getElementById("manga-izquierda")
            .getAttribute("fill"),
          mangader: document
            .getElementById("manga-derecha")
            .getAttribute("fill"),
          cuelloizq: document.getElementById("cuelloizq").getAttribute("fill"),
          cuelloder: document.getElementById("cuelloder").getAttribute("fill"),
        };


        // Enviar via fetch al servidor
        const resp = await fetch("/api/camisetas", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token, // incluir token si es ruta protegida
          },
          body: JSON.stringify(datos),
        });
        const data = await resp.json();
        console.log("Diseño guardado en servidor:", data);
        alert("Diseño guardado exitosamente");
        cargarTabla(); // Refresca la tabla de camisetas
      });

      
        // Modificar una camiseta existente usando PUT
        btnModificarReal.addEventListener("click", async () => {
          const diseño = obtenerColoresActuales();
          const id = camisetaIdInput.value;
          const resp = await fetch(`/api/camisetas/${id}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
            body: JSON.stringify(diseño),
          });
          await resp.json();
          cargarTabla(); // Refresca tabla
          btnLimpiar.click(); // Limpia formulario
          btnGuardar.style.display = "inline";
          btnModificarReal.style.display = "none";
        });


        function obtenerColoresActuales() {
          return {
            torso: document.getElementById("torso").getAttribute("fill"),
            mangaizq: document
              .getElementById("manga-izquierda")
              .getAttribute("fill"),
            mangader: document
              .getElementById("manga-derecha")
              .getAttribute("fill"),
            cuelloizq: document.getElementById("cuelloizq").getAttribute("fill"),
            cuelloder: document.getElementById("cuelloder").getAttribute("fill"),
          };
        }

    </script>

    <script>
      async function cargarTabla() {
        const resp = await fetch("/api/camisetas", {
          headers: { 'Authorization': "Bearer " + localStorage.getItem("token") },
        });
        const camisetas = await resp.json();
        console.log("Camisetas obtenidas:", camisetas);
        // Inicializar la tabla como DataTable (asociada al elemento HTML con id 'tabla-camisetas')
        const tabla = $("#tabla-camisetas").DataTable();

      tabla.clear(); // Limpiar tabla antes de recargar datos


        // Suponiendo que tenemos la lista de camisetas disponible en la variable `camisetas` (por ejemplo, insertada desde el servidor o recibida via AJAX):
        camisetas.forEach((c) => {
          // Determinar el nombre a mostrar para el creador de la camiseta
          let nombreCreador = "Desconocido";
          if (c.creador && typeof c.creador === "object") {
            // Si 'creador' es un objeto, tomamos su nombre, o correo si no hay nombre, o 'Usuario' genérico
            nombreCreador = c.creador.nombre || c.creador.correo || "Usuario";
          } else if (typeof c.creador === "string") {
            // Si 'creador' es una cadena (por ejemplo un nombre ya o un ID en texto), lo usamos directamente
            nombreCreador = c.creador;
          }

          // Añadir una nueva fila a la tabla con los datos de la camiseta
          tabla.row.add([
            generarMiniatura(c), // Columna 1: Miniatura de la camiseta (HTML de imagen/SVG)
            new Date(c.fechaCreacion).toLocaleString(), // Columna 2: Fecha de creación en formato legible
            nombreCreador, // Columna 3: Nombre/Correo del creador (nuevo campo)
            // Columna 4: Botones de acciones (Modificar/Eliminar), con el ID incrustado en la llamada
            `<button class='btn-like' onclick='editarCamiseta("${c._id}")'>Modificar</button>
     <button class='btn-dislike' onclick='eliminarCamiseta("${c._id}")'>Eliminar</button>`,
          ]);
        });

        // Finalmente, dibujar/refrescar la tabla para que muestre las filas añadidas
        tabla.draw();
      }

      function generarMiniatura(c) {
        return `
<svg class="miniatura" viewBox="1 2 26 14">
<path d="M 4 8 M 5 3 L 5 6 L 3 7 L 1 5" fill="${c.mangaizq}" />
<path d="M 9 5 L 7 3 L 5 3 L 5 6 L 5 12 L 13 12 L 13 6 L 13 3 L 11 3" fill="${c.torso}" />
<path d="M 13 6 L 13 3 L 17 5 L 15 7" fill="${c.mangader}" />
<path d="M 8 2 L 7 3 L 9 5 L 8 3" fill="${c.cuelloizq}" />
<path d="M 10 2 L 11 3 L 9 5 L 10 3 M 1 4" fill="${c.cuelloder}" />
</svg>`;
      }

      async function editarCamiseta(id) {
        const resp = await fetch(`/api/camisetas/${id}`, {
          headers: { Authorization: "Bearer " + localStorage.getItem("token") },
        });
        const c = await resp.json();
        // Cargar los colores en el SVG principal
        document.getElementById("torso").setAttribute("fill", c.torso);
        document
          .getElementById("manga-izquierda")
          .setAttribute("fill", c.mangaizq);
        document
          .getElementById("manga-derecha")
          .setAttribute("fill", c.mangader);
        document
          .getElementById("cuelloder")
          .setAttribute("fill", c.cuelloder);
        document
          .getElementById("cuelloizq")
          .setAttribute("fill", c.cuelloizq);
        // Guardar el ID actual y cambiar visibilidad de botones
        camisetaIdInput.value = c._id;
        btnGuardar.style.display = "none";
        btnModificarReal.style.display = "inline";
      }

      // Elimina una camiseta después de confirmar
      async function eliminarCamiseta(id) {
        if (!confirm("¿Está seguro de eliminar esta camiseta?")) return;
        await fetch(`/api/camisetas/${id}`, {
          method: "DELETE",
          headers: { Authorization: "Bearer " + localStorage.getItem("token") },
        });
        cargarTabla(); // Refresca tabla
      }

      // Inicializa la tabla al cargar la página
      $(document).ready(() => {
        $("#tabla-camisetas").DataTable({ responsive: true });
        cargarTabla(); // Llamada inicial
      });
    </script>
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("/service-worker.js")
            .then((registration) => {
              console.log("Service Worker registrado con éxito:", registration);
            })
            .catch((err) => {
              console.log("Fallo en el registro del Service Worker:", err);
            });
        });
      }
    </script>
    <script src="/js/redirect.js"></script>
  </body>
</html>
